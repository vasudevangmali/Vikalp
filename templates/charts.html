{% extends 'base.html' %}

{% block content %}

  <h3 class="mb-3">Crop Production Insights</h3>

  <!-- Filter card -->
  <div class="card mb-3">
    <div class="card-body">
      <form method="post" class="row g-3">
        <div class="col-md-4">
          <label class="form-label">District</label>
          <select name="district" class="form-select">
            <option value="">— All Districts —</option>
            {% for d in districts %}
              <option value="{{ d }}" {% if d == selected_district %}selected{% endif %}>{{ d }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label">Block</label>
          <select name="block" class="form-select">
            <option value="">— All Blocks —</option>
            {% for b in blocks %}
              <option value="{{ b }}" {% if b == selected_block %}selected{% endif %}>{{ b }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-2 align-self-end">
          <button type="submit" class="btn btn-success">Apply</button>
          <a href="{{ url_for('analysis') }}" class="btn btn-outline-secondary ms-2">Reset</a>
        </div>
      </form>
    </div>
  </div>

  <!-- Summary cards -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="card card-page text-center p-3">
        <h6>Mango (કેરી)</h6>
        <h4 class="text-success">{{ total_mango or 0 }}</h4>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card card-page text-center p-3">
        <h6>Lemon (લીંબુ)</h6>
        <h4 class="text-warning">{{ total_lemon or 0 }}</h4>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card card-page text-center p-3">
        <h6>Chiku (ચીકુ)</h6>
        <h4 class="text-info">{{ total_chiku or 0 }}</h4>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card card-page text-center p-3">
        <h6>Guava (જમરૂખ)</h6>
        <h4 class="text-danger">{{ total_guava or 0 }}</h4>
      </div>
    </div>
  </div>

  <!-- Charts row -->
  <div class="row">
    <div class="col-md-8 mb-4">
      <div class="card card-page">
        <div class="card-body" style="height:380px;">
          {% if years and years|length and mango and lemon and chiku %}
            <div class="chart-container" style="height:100%;">
              <canvas id="trendChart"></canvas>
            </div>
          {% else %}
            <p class="mb-0">No trend data available.</p>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="col-md-4 mb-4">
      <div class="card card-page">
        <div class="card-body" style="height:380px;">
          {% if total_mango is defined %}
            <div class="chart-container" style="height:100%;">
              <canvas id="shareChart"></canvas>
            </div>
          {% else %}
            <p class="mb-0">No share data available.</p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

{% endblock %}

{% block scripts %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const normalize = arr => (arr || []).map(v => {
      if (v === null || v === undefined || v === '') return 0;
      const n = Number(String(v).replace(/,/g, ''));
      return Number.isFinite(n) ? n : 0;
    });

    // Trend chart
    {% if years and years|length and mango and lemon and chiku %}
    (function(){
      const labels = {{ years|tojson }};
      const mangoData = normalize({{ mango|tojson }});
      const lemonData = normalize({{ lemon|tojson }});
      const chikuData = normalize({{ chiku|tojson }});
      const guavaData = normalize({{ guava|tojson }} || []);

      const ctxLine = document.getElementById('trendChart').getContext('2d');
      new Chart(ctxLine, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            { label: 'Mango', data: mangoData, borderColor: 'rgba(46,125,50,1)', backgroundColor: 'rgba(46,125,50,0.08)', fill: false },
            { label: 'Lemon', data: lemonData, borderColor: 'rgba(255,193,7,1)', backgroundColor: 'rgba(255,193,7,0.06)', fill: false },
            { label: 'Chiku', data: chikuData, borderColor: 'rgba(13,110,253,1)', backgroundColor: 'rgba(13,110,253,0.06)', fill: false },
            { label: 'Guava', data: guavaData, borderColor: 'rgba(220,53,69,1)', backgroundColor: 'rgba(220,53,69,0.06)', fill: false }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { position: 'bottom' }, title: { display: true, text: 'Yearly Crop Production Trends' } },
          scales: { y: { beginAtZero: true } }
        }
      });
    })();
    {% endif %}

    // Share pie chart
    {% if total_mango is defined %}
    (function(){
      const totals = [{{ total_mango or 0 }}, {{ total_lemon or 0 }}, {{ total_chiku or 0 }}, {{ total_guava or 0 }}];
      const ctxPie = document.getElementById('shareChart').getContext('2d');
      new Chart(ctxPie, {
        type: 'pie',
        data: {
          labels: ['Mango','Lemon','Chiku','Guava'],
          datasets: [{ data: totals, backgroundColor: ['#2e7d32','#ffc107','#0d6efd','#dc3545'] }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' }, title: { display: true, text: 'Crop Share Overview' } } }
      });
    })();
    {% endif %}
  </script>
{% endblock %}
